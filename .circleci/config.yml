# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
version: 2
jobs:
  Fabric:
    machine:
        image: circleci/classic:latest
    environment:
        BENCHMARK: fabric
    working_directory: ~/repo

    steps:
      - checkout
      - run:
          name: Setup nvm and npm
          command: |
            set +e
            curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.5/install.sh | bash
            export NVM_DIR="/opt/circleci/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm install v8.15
            nvm alias default 8.15

            # Each step uses the same `$BASH_ENV`, so need to modify it to keep nvm settings
            echo 'export NVM_DIR="/opt/circleci/.nvm"' >> $BASH_ENV
            echo "[ -s \"$NVM_DIR/nvm.sh\" ] && . \"$NVM_DIR/nvm.sh\"" >> $BASH_ENV
      - run:
          name: Install project dependancies
          command: npm install
      - run:
          name: Bootstrap
          command: npm run bootstrap
      - run:
          name: Unit Test
          command: npm test
      - run:
          name: Integration tests
          command: './packages/caliper-tests-integration/scripts/run-tests-direct.sh'
  Composer:
    machine:
        image: circleci/classic:latest
    environment:
        BENCHMARK: composer
    working_directory: ~/repo

    steps:
      - checkout
      - run:
          name: Setup nvm and npm
          command: |
            set +e
            curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.5/install.sh | bash
            export NVM_DIR="/opt/circleci/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm install v8.15
            nvm alias default 8.15

            # Each step uses the same `$BASH_ENV`, so need to modify it to keep nvm settings
            echo 'export NVM_DIR="/opt/circleci/.nvm"' >> $BASH_ENV
            echo "[ -s \"$NVM_DIR/nvm.sh\" ] && . \"$NVM_DIR/nvm.sh\"" >> $BASH_ENV
      - run:
          name: Install project dependancies
          command: npm install
      - run:
          name: Bootstrap
          command: npm run bootstrap
      - run:
          name: Unit Test
          command: npm test
      - run:
          name: Integration tests
          command: './packages/caliper-tests-integration/scripts/run-tests-direct.sh'

workflows:
 version: 2
 Example_Workflow:
   jobs:
     - Fabric
     - Composer
